#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/wait.h>
#include <time.h>

int main (void) 
{
  time_t t;
  int ret, retCode, status, randPos, method;
  int counter = 0;
  int fuzzes = 2000;
  
  srand((unsigned) time(&t));
  
  for (int i = 0; i < fuzzes; i++)
  {
    FILE *fin = fopen("./cross.jpg", "rb"); 
    
    if(fin == NULL){   
        printf("Error in opening the image");
        fclose(fin);
        exit(0);   
    }
    
    /*** Find the length of the image ***/
    fseek(fin, 0, SEEK_END);
    unsigned long length = ftell(fin);
    rewind(fin); 
    
    /*** Read image into array ***/
    //char *buffer = (char *)malloc((length+1)*sizeof(char));
    char *buffer = (char *)malloc(length+1);
    fread(buffer, length, 1, fin);
    fclose(fin);
    
    /*** Mutate the input image ***/     
    /* Change 4 bytes at 4 random locations to value between 0 and 255*/
    for (int j = 0; j < 4; j++)
    {
      randPos = rand() % length;    
      buffer[randPos] = rand() % 256;
    }
    
    /*** Write mutation to a jpg file ***/
    FILE *fout = fopen("./test.jpg", "wb");
    fwrite(buffer, 1, length, fout);
    fclose(fout);
    
    /*** Pass the mutated file as input to jpg2bmp ***/
    char commandBuffer[200];
    sprintf(commandBuffer, "./jpg2bmp test.jpg temp.bmp");
        
    ret = system(commandBuffer);
    wait(&status); 
  	retCode = WEXITSTATUS(ret); 
   
    /*** If the code hit a bug, save that mutated jpg file ***/   
  	if ( retCode == 128+11 || retCode ==128+6)  
  	{
      char fileName[30]; 
      sprintf(fileName, "crashed-%d.jpg", counter);
      counter++;  
      fprintf(stderr, "file '%s' is generated\n", fileName);
      FILE *testjpg = fopen(fileName, "wb");
      fwrite(buffer, 1, length, testjpg);
      fclose(testjpg);  	
    	fflush(stdout);
  	}   
    free(buffer);
  }
}
